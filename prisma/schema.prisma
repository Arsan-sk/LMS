generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MEMBER
  LEAD
  ADMIN
}

enum ResourceType {
  DRIVE_LINK
  PDF
  VIDEO
  DOC
  EXTERNAL_LINK
  IMAGE
}

enum SubmissionType {
  FILE
  IN_PERSON
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  CHECKED
  REJECTED
}

enum QuestionType {
  MCQ
  SHORT_ANSWER
  LONG_ANSWER
}

model User {
  id             String         @id @default(cuid())
  username       String         @unique
  email          String         @unique
  passwordHash   String
  role           Role           @default(MEMBER)
  phone          String?
  year           String?
  department     String?
  bio            String?
  profilePhoto   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  domainId       String?
  domain         Domain?        @relation(fields: [domainId], references: [id], onDelete: SetNull)
  
  ledDomains     DomainLead[]
  resources      Resource[]
  assignments    Assignment[]   @relation("CreatedAssignments")
  quizzes        Quiz[]         @relation("CreatedQuizzes")
  submissions    Submission[]   @relation("UserSubmissions")
  gradedSubmissions Submission[] @relation("GradedSubmissions")
  pointsEntries  PointsEntry[]  @relation("UserPoints")
  awardedPoints  PointsEntry[]  @relation("AwardedPoints")
  notifications  Notification[]
  activityLogs   ActivityLog[]
}

model Domain {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  maxCapacity Int          @default(60)
  roadmapJson Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  users       User[]
  leads       DomainLead[]
  resources   Resource[]
  assignments Assignment[]
  quizzes     Quiz[]
}

model DomainLead {
  id        String   @id @default(cuid())
  userId    String
  domainId  String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  domain    Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([userId, domainId])
}

model Resource {
  id          String       @id @default(cuid())
  domainId    String
  title       String
  description String?
  type        ResourceType
  url         String
  uploadedBy  String?
  tags        Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  domain      Domain       @relation(fields: [domainId], references: [id], onDelete: Cascade)
  uploader    User?        @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
}

model Assignment {
  id                String         @id @default(cuid())
  domainId          String
  title             String
  description       String?
  pointsBase        Int
  timelyBonusPoints Int            @default(0)
  submissionType    SubmissionType
  dueDate           DateTime?
  published         Boolean        @default(false)
  createdBy         String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  domain            Domain         @relation(fields: [domainId], references: [id], onDelete: Cascade)
  creator           User?          @relation("CreatedAssignments", fields: [createdBy], references: [id], onDelete: SetNull)
  submissions       Submission[]
}

model Quiz {
  id          String   @id @default(cuid())
  domainId    String
  title       String
  description String?
  totalPoints Int      @default(0)
  published   Boolean  @default(false)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  domain      Domain     @relation(fields: [domainId], references: [id], onDelete: Cascade)
  creator     User?      @relation("CreatedQuizzes", fields: [createdBy], references: [id], onDelete: SetNull)
  questions   Question[]
  submissions Submission[]
}

model Question {
  id            String       @id @default(cuid())
  quizId        String
  questionText  String
  questionType  QuestionType
  options       Json?        // For MCQ: ["Option A", "Option B", ...]
  correctAnswer Json?        // For MCQ: index or value
  points        Int          @default(1)
  
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model Submission {
  id           String           @id @default(cuid())
  userId       String
  assignmentId String?
  quizId       String?
  files        Json?            // Array of file URLs
  answerText   String?
  status       SubmissionStatus @default(PENDING)
  gradePoints  Int?
  gradedBy     String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  user         User        @relation("UserSubmissions", fields: [userId], references: [id], onDelete: Cascade)
  assignment   Assignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  quiz         Quiz?       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  grader       User?       @relation("GradedSubmissions", fields: [gradedBy], references: [id], onDelete: SetNull)
}

model PointsEntry {
  id         String   @id @default(cuid())
  userId     String
  sourceType String   // "QUIZ", "ASSIGNMENT", "MANUAL"
  sourceId   String?
  points     Int
  reason     String?
  awardedBy  String?
  createdAt  DateTime @default(now())

  user       User     @relation("UserPoints", fields: [userId], references: [id], onDelete: Cascade)
  awarder    User?    @relation("AwardedPoints", fields: [awardedBy], references: [id], onDelete: SetNull)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  meta      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  actionType String
  meta       Json?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
